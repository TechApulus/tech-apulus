<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard</title>
  <link rel="shortcut icon" href="img/logo.png" type="image/svg+xml">
  <link rel="stylesheet" href="style/dashboard.css">
  <link rel="stylesheet" href="style/style.css">


  <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>

<body onload="alertas()">
  <div class="menu menu-perdas">
    <div class="button-menu" onclick="menuClick()">
      <div class="bar-menu"></div>
      <div class="bar-menu"></div>
      <div class="bar-menu"></div>
    </div>
    <span class="content-items">
      <div class="blocoTextoMenu">
        <span class="textoMenu">Dashboard</span>
        <a href="dashboard.html" class="dash"><ion-icon name="stats-chart" class="ionicons"
            style="color: rgb(63, 46, 34);"></ion-icon></a>
      </div>
      <div class="blocoTextoMenu">
        <span class="textoMenu" style="width: 75px; margin-right: 0;">Perdas</span>
        <a href="relatorio.html" class="dash"><ion-icon name="document-outline" class="ionicons"></ion-icon></a>
      </div>
      <div class="blocoTextoMenu">
        <span class="textoMenu" style="width: 75px; margin-right: 0;">Fazendas</span>
        <a href="fazendas.html" class="dash"><ion-icon name="home-outline" class="ionicons"></ion-icon></a>
      </div>
      <div class="blocoTextoMenu">
        <span class="textoMenu" style="width: 75px; margin-right: 0;">Perfil</span>
        <a href="telaUsuario.html" class="dash"><ion-icon name="person-circle-outline" class="ionicons"></ion-icon></a>
      </div>
      <div class="blocoTextoMenu">
        <span class="textoMenu" style="width: 75px; margin-right: 0;">Sair</span>
        <a href="login.html" class="dash"><ion-icon name="exit-outline" class="ionicons"></ion-icon></ion-icon></a>
      </div>
    </span>
  </div>
  <br> <br> <br>

  <div vw class="enabled">
    <div vw-access-button class="active"></div>
    <div vw-plugin-wrapper>
      <div class="vw-plugin-top-wrapper"></div>
    </div>
  </div>

  <div class="content-dash">
    <div>
      <div class="alertas">
        <h1>Situações dos Armazéns</h1>
        <div class="alertasArmazens">
          <div id="cardAlertaTemp" class="cardAlertaTemp">
            <div id="msgAlertaTemp" class="msgAlerta msgAlertaTemp"></div>
          </div>

          <div id="cardAlertaUmid" class="cardAlertaUmid">
            <div id="msgAlertaUmid" class="msgAlerta msgAlertaUmid"></div>
          </div>
        </div>

        <a id="btnAbrirMetricas" class="login-btn">Ver Métricas</a>

        <div class="telaMetricas">
          <h1>Métricas</h1>
          <div class="metricas">
            <table>
              <thead>
                <tr>
                  <th>Unidade de Medida</th>
                  <th style="color: blue;">Minimo</th>
                  <th style="color: dodgerblue;">Média</th>
                  <th style="color: limegreen;">Ideal</th>
                  <th style="color: limegreen;">Ideal</th>
                  <th style="color: orangered;">Média</th>
                  <th style="color: red;">Máxima</th>
                </tr>
              </thead>

              <tbody>
                <tr>
                  <th>Temperatura</th>
                  <td style="color: blue;">14°C</td>
                  <td style="color: dodgerblue;">17°C</td>
                  <td style="color: limegreen;">20°C</td>
                  <td style="color: limegreen;">23°C</td>
                  <td style="color: orangered;">24°C</td>
                  <td style="color: red;">26°C</td>
                </tr>
                <tr>
                  <th>Umidade</th>
                  <td style="color: blue;">55%</td>
                  <td style="color: dodgerblue;">58%</td>
                  <td style="color: limegreen;">60%</td>
                  <td style="color: limegreen;">65%</td>
                  <td style="color: orangered;">67%</td>
                  <td style="color: red;">69%</td>
                </tr>
              </tbody>
            </table>
          </div> <br>
          <a id="btnFecharMetricas" class="login-btn">Fechar</a>
        </div>

      </div>

      <br> <br>

      <!-- Começo dos Gráficos -->
      <span id="name_user"></span>
      <div class="mainGraficos">
        <h1>Visão Geral das Fazendas</h1>


        <a id="btnAddGraf" class="login-btn">Adicionar Gráfico</a>
        <div class="grafFazendas">
        </div>
      </div>
      <!-- Fim dos Gráficos -->

      <br> <br> <br>

      <!-- Começo Script -->

      <!-- Fim Script -->
      </span>
    </div>
  </div>
</body>

</html>
<script type="text/javascript" src="scripts/dashboard.js"></script>
<script src="./scripts/teste.js"> </script>
<!-- 
    - ionicon link
  -->
<script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
<script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>
<script>
  new window.VLibras.Widget('https://vlibras.gov.br/app');
</script>

<!-- Por enquanto o script debaixo está dando erro, pois não temos a parte do back dos armazéns ainda, mas quando criarmos, alguns ajustes e os gráficos podem aparecer, a base está no 'teste.js', então só substituir os dados mocados por reais do usuário, e aparentemente pronto :) -->


<!-- <script>
  let atualizarDados;

  window.onload = exibirAquariosDoUsuario();

  function exibirAquariosDoUsuario() {
    var armazens = JSON.parse(sessionStorage.ARMAZENS);
    armazens.forEach(item => {
      document.getElementById("btnAddGraf").innerHTML += `
            <button class="btn-chart" onclick="exibirArmazem(${item.id})" id="btnAddGraf${item.id}">${item.descricao}</button>
            `

      document.getElementById("graficos").innerHTML += `
                <div id="grafico${item.id}" class="display-none">
                    <h3 class="tituloGraficos">
                        <span id="tituloAquario${item.id}">${item.descricao}</span>
                    </h3>
                    <div class="graph">
                        <canvas id="myChartCanvas${item.id}"></canvas>
                    </div>
                    <div class="label-captura">
                        <p id="avisoCaptura${item.id}" style="color: white"></p>
                    </div>
                </div>
            `

      obterDadosGrafico(item.id)
    });

    if (armazens.length > 0) {
      exibirArmazem(armazens[0].id)
    }
  }

  function exibirAquario(idAquario) {
    let todosOsGraficos = JSON.parse(sessionStorage.AQUARIOS);

    for (i = 0; i < todosOsGraficos.length; i++) {
      // exibindo - ou não - o gráfico
      if (todosOsGraficos[i].id != idAquario) {
        let elementoAtual = document.getElementById(`grafico${todosOsGraficos[i].id}`)
        if (elementoAtual.classList.contains("display-block")) {
          elementoAtual.classList.remove("display-block")
        }
        elementoAtual.classList.add("display-none")

        // alterando estilo do botão
        let btnAtual = document.getElementById(`btnAquario${todosOsGraficos[i].id}`)
        if (btnAtual.classList.contains("btn-pink")) {
          btnAtual.classList.remove("btn-pink")
        }
        btnAtual.classList.add("btn-white")
      }
    }

    let graficoExibir = document.getElementById(`grafico${idAquario}`)
    graficoExibir.classList.remove("display-none")
    graficoExibir.classList.add("display-block")

    function obterDados() {
      if (atualizarDados != undefined) {
        clearTimeout(atualizarDados);
      }

      fetch(`/medidas/ultimas/${idAquario}`, { cache: 'no-store' }).then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            console.log(`Dados recebidos: ${JSON.stringfy(resposta)}`);
            resposta.reverse();

            plotarGraf(resposta, idAquario);
          });
        }

        else {
          console.error('Nenhum dado encontrado');
        }
      })

        .catch(function (error) {
          console.error(`Erros na obtenção dos Gráficos: ${error.message}`);
        });
    }

    function plotarGraf(resposta, idAquario) {
      console.log('Plotando os Gráficos...')

      let labels = [];

      let dados = {
        labels: labels,
        datasets: [{
          labels: 'Umidade',
          data: [],
          fill: false,
          borderColor: '#9c6b43',
          tension: 0.1
        },
        {
          label: 'Temperatura',
          data: [],
          fill: false,
          borderColor: 'rgb(255, 0, 0)',
          tension: 0.1
        }]
      };

      console.log('----------------------------------------------')
      console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
      console.log(resposta)

      // Inserindo valores recebidos em estrutura para plotar o gráfico
      for (i = 0; i < resposta.length; i++) {
        var registro = resposta[i];
        labels.push(registro.momento_grafico);
        dados.datasets[0].data.push(registro.umidade);
        dados.datasets[1].data.push(registro.temperatura);
      }

      console.log('----------------------------------------------')
      console.log('O gráfico será plotado com os respectivos valores:')
      console.log('Labels:')
      console.log(labels)
      console.log('Dados:')
      console.log(dados.datasets)
      console.log('----------------------------------------------')

      // Criando estrutura para plotar gráfico - config
      const config = {
        type: 'line',
        data: dados,
      };

      // Adicionando gráfico criado em div na tela
      let myChart = new Chart(
        document.getElementById(`myChartCanvas${idAquario}`),
        config
      );

      setTimeout(() => atualizarGraf(idAquario, dados, myChart), 2000);
    }

    function atualizarGraf(idAquario, dados, myChart) {
      fetch(`/medidas/tempo-real/${idAquario}`, { cache: 'no-store' }).then(function (response) {
        if (response.ok) {
          response.json().then(function (registrarNovo) {
            obterdados(idAquario);
            // alertar(novoRegistro, idAquario);
            console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
            console.log(`Dados atuais do gráfico:`);
            console.log(dados);

            let avisoCaptura = document.getElementById(`avisoCaptura${idAquario}`)
            avisoCaptura.innerHTML = ""


            if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {
              console.log("---------------------------------------------------------------")
              console.log("Como não há dados novos para captura, o gráfico não atualizará.")
              avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
              console.log("Horário do novo dado capturado:")
              console.log(novoRegistro[0].momento_grafico)
              console.log("Horário do último dado capturado:")
              console.log(dados.labels[dados.labels.length - 1])
              console.log("---------------------------------------------------------------")
            } else {
              // tirando e colocando valores no gráfico
              dados.labels.shift(); // apagar o primeiro
              dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

              dados.datasets[0].data.shift();  // apagar o primeiro de umidade
              dados.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de umidade

              dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
              dados.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

              myChart.update();
            }

            // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
            proximaAtualizacao = setTimeout(() => atualizarGraf(idAquario, dados, myChart), 2000);
          });
        } else {
          console.error('Nenhum dado encontrado ou erro na API');
          // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
          proximaAtualizacao = setTimeout(() => atualizarGraf(idAquario, dados, myChart), 2000);
        }
      })
        .catch(function (error) {
          console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        });
    }
  }
</script> -->